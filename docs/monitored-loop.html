<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ralph+ Monitored Loop</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: #0f1117; color: #e1e4e8; padding: 40px; }
  h1 { text-align: center; font-size: 1.6rem; font-weight: 600; margin-bottom: 8px; color: #fff; }
  .subtitle { text-align: center; color: #8b949e; margin-bottom: 48px; font-size: 0.95rem; }

  .diagram { max-width: 900px; margin: 0 auto; position: relative; }

  /* Vertical spine */
  .spine { position: absolute; left: 50%; top: 0; bottom: 0; width: 3px; background: #30363d; transform: translateX(-50%); z-index: 0; }

  .step { position: relative; display: flex; align-items: flex-start; margin-bottom: 12px; z-index: 1; }
  .step.left .box { margin-right: auto; margin-left: 0; }
  .step.right .box { margin-left: auto; margin-right: 0; }
  .step.center .box { margin: 0 auto; }

  .box {
    width: 42%;
    border: 2px solid #30363d;
    border-radius: 12px;
    padding: 16px 20px;
    background: #161b22;
    position: relative;
  }
  .box h3 { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px; }
  .box p { font-size: 0.82rem; color: #8b949e; line-height: 1.5; }
  .box code { background: #21262d; padding: 2px 6px; border-radius: 4px; font-size: 0.78rem; color: #c9d1d9; }

  .step.center .box { width: 52%; border-width: 2px; }

  /* Color accents */
  .accent-blue { border-color: #388bfd; }
  .accent-blue h3 { color: #58a6ff; }
  .accent-green { border-color: #2ea043; }
  .accent-green h3 { color: #3fb950; }
  .accent-orange { border-color: #d29922; }
  .accent-orange h3 { color: #e3b341; }
  .accent-red { border-color: #da3633; }
  .accent-red h3 { color: #f85149; }
  .accent-purple { border-color: #8957e5; }
  .accent-purple h3 { color: #a371f7; }
  .accent-gray { border-color: #484f58; }
  .accent-gray h3 { color: #8b949e; }

  /* Connector dot on spine */
  .dot {
    position: absolute;
    left: 50%;
    top: 20px;
    width: 14px; height: 14px;
    border-radius: 50%;
    background: #30363d;
    border: 3px solid #0f1117;
    transform: translateX(-50%);
    z-index: 2;
  }
  .accent-blue .dot, .step:has(.accent-blue) .dot { background: #388bfd; }
  .accent-green .dot, .step:has(.accent-green) .dot { background: #2ea043; }
  .accent-orange .dot, .step:has(.accent-orange) .dot { background: #d29922; }
  .accent-red .dot, .step:has(.accent-red) .dot { background: #da3633; }
  .accent-purple .dot, .step:has(.accent-purple) .dot { background: #8957e5; }

  /* Decision diamond */
  .decision {
    width: 56%;
    margin: 0 auto;
    background: #161b22;
    border: 2px dashed #484f58;
    border-radius: 12px;
    padding: 16px 20px;
    text-align: center;
  }
  .decision h3 { color: #8b949e; font-size: 0.82rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px; }
  .decision p { font-size: 0.82rem; color: #8b949e; }

  /* Branch outcomes row */
  .branches {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-bottom: 12px;
    z-index: 1;
    position: relative;
  }
  .branch {
    flex: 1;
    max-width: 28%;
    border: 2px solid #30363d;
    border-radius: 10px;
    padding: 14px 16px;
    background: #161b22;
    text-align: center;
  }
  .branch h3 { font-size: 0.78rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; }
  .branch p { font-size: 0.78rem; color: #8b949e; line-height: 1.4; }

  /* Signal badge */
  .signal {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 0.72rem;
    font-weight: 600;
    letter-spacing: 0.03em;
    margin-top: 6px;
  }
  .signal-done { background: #0d2818; color: #3fb950; border: 1px solid #2ea043; }
  .signal-fail { background: #2a1c0a; color: #e3b341; border: 1px solid #d29922; }
  .signal-blocked { background: #2d1215; color: #f85149; border: 1px solid #da3633; }
  .signal-timeout { background: #1c1c2e; color: #8b949e; border: 1px solid #484f58; }

  /* Arrow labels */
  .arrow-label {
    text-align: center;
    color: #484f58;
    font-size: 0.75rem;
    margin: -4px 0 8px;
    position: relative;
    z-index: 1;
  }
  .arrow-label span { background: #0f1117; padding: 0 8px; }

  /* Loop-back arrow */
  .loop-back {
    position: relative;
    z-index: 1;
    text-align: center;
    margin: 8px 0 12px;
  }
  .loop-back .arrow {
    display: inline-block;
    border: 2px dashed #484f58;
    border-radius: 0 0 20px 20px;
    border-top: none;
    padding: 8px 40px;
    color: #8b949e;
    font-size: 0.78rem;
  }

  /* Legend */
  .legend {
    max-width: 900px;
    margin: 48px auto 0;
    padding: 20px 24px;
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 12px;
  }
  .legend h3 { font-size: 0.85rem; color: #8b949e; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em; }
  .legend-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 32px; }
  .legend-item { display: flex; align-items: center; gap: 10px; font-size: 0.82rem; }
  .legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

  /* Parallel indicator */
  .parallel-bar {
    display: flex;
    justify-content: center;
    gap: 24px;
    margin-bottom: 12px;
    position: relative;
    z-index: 1;
  }
  .parallel-bar .pbox {
    width: 38%;
    border: 2px solid #30363d;
    border-radius: 10px;
    padding: 14px 18px;
    background: #161b22;
  }
  .parallel-bar .pbox h3 { font-size: 0.82rem; margin-bottom: 4px; }
  .parallel-bar .pbox p { font-size: 0.78rem; color: #8b949e; line-height: 1.4; }
  .parallel-label {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #0f1117;
    padding: 2px 10px;
    border: 1px solid #30363d;
    border-radius: 6px;
    font-size: 0.7rem;
    color: #484f58;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    z-index: 3;
  }
</style>
</head>
<body>

<h1>Ralph+ Monitored Loop</h1>
<p class="subtitle">How run-monitored.sh drives the orchestrator through iterations using activity log signals</p>

<div class="diagram">
  <div class="spine"></div>

  <!-- 1. Start -->
  <div class="step center">
    <div class="dot" style="background:#388bfd"></div>
    <div class="box accent-blue">
      <h3>run-monitored.sh starts</h3>
      <p>Creates tmux session, writes state files (<code>.current-task</code>, <code>.current-iteration</code>, etc.), begins iteration loop.</p>
    </div>
  </div>

  <div class="arrow-label"><span>iteration i = 1 .. MAX</span></div>

  <!-- 2. Launch provider + parallel helpers -->
  <div class="step center">
    <div class="dot" style="background:#8957e5"></div>
    <div class="box accent-purple" style="width:56%">
      <h3>Launch provider CLI (interactive)</h3>
      <p>Starts <code>claude --dangerously-skip-permissions</code> (or codex) in the tmux pane. Full TUI visible.</p>
    </div>
  </div>

  <div class="arrow-label"><span>two background processes spawn in parallel</span></div>

  <div class="parallel-bar">
    <div class="pbox accent-blue">
      <h3 style="color:#58a6ff">Injector</h3>
      <p>Waits 15s for TUI init, then pastes <code>CLAUDE.md</code> prompt into tmux buffer and sends Enter.</p>
    </div>
    <div class="parallel-label">parallel</div>
    <div class="pbox accent-purple">
      <h3 style="color:#a371f7">Watcher</h3>
      <p>Waits 60s minimum, then polls activity log every 10s for:<br>
      <code>[i/MAX] orchestrator: ITERATION_(DONE|FAIL|BLOCKED)</code><br>
      45-min timeout if no signal found.</p>
    </div>
  </div>

  <div class="arrow-label"><span>orchestrator runs pipeline (planner, tdd, e2e, quality-gate, committer)</span></div>

  <!-- 3. Orchestrator logs signal -->
  <div class="step center">
    <div class="dot" style="background:#2ea043"></div>
    <div class="box accent-green" style="width:60%">
      <h3>Orchestrator logs ITERATION signal</h3>
      <p>As its very last action, the orchestrator prepends one of these to the activity log:</p>
      <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; justify-content:center">
        <span class="signal signal-done">ITERATION_DONE</span>
        <span class="signal signal-fail">ITERATION_FAIL</span>
        <span class="signal signal-blocked">ITERATION_BLOCKED</span>
      </div>
    </div>
  </div>

  <div class="arrow-label"><span>watcher detects signal via grep</span></div>

  <!-- 4. Watcher sends /exit -->
  <div class="step center">
    <div class="dot" style="background:#8957e5"></div>
    <div class="box accent-purple">
      <h3>Watcher sends /exit</h3>
      <p>Waits 15s grace period, then sends <code>/exit</code> via <code>tmux send-keys</code>. Writes signal type to result file. Provider CLI exits.</p>
    </div>
  </div>

  <div class="arrow-label"><span>loop reads watcher result</span></div>

  <!-- 5. Decision: which signal? -->
  <div class="step center" style="margin-bottom:16px">
    <div class="dot" style="background:#484f58"></div>
    <div class="decision">
      <h3>Which signal?</h3>
      <p>The loop reads the watcher result file and branches</p>
    </div>
  </div>

  <!-- 6. Four outcomes -->
  <div class="branches">
    <div class="branch accent-green">
      <h3 style="color:#3fb950">ITERATION_DONE</h3>
      <p>Story passed quality gate and was committed.</p>
      <p style="margin-top:6px; color:#3fb950; font-size:0.75rem">Check <code>all_stories_pass()</code></p>
    </div>
    <div class="branch accent-orange">
      <h3 style="color:#e3b341">ITERATION_FAIL</h3>
      <p>Quality gate failed. Story marked with notes.</p>
      <p style="margin-top:6px; color:#e3b341; font-size:0.75rem">Check <code>all_stories_pass()</code></p>
    </div>
    <div class="branch accent-red">
      <h3 style="color:#f85149">ITERATION_BLOCKED</h3>
      <p>Environment broken. Cannot continue.</p>
      <p style="margin-top:6px; color:#f85149; font-size:0.75rem"><code>exit 1</code> immediately</p>
    </div>
    <div class="branch accent-gray">
      <h3 style="color:#8b949e">TIMEOUT</h3>
      <p>No signal in 45 min.</p>
      <p style="margin-top:6px; color:#8b949e; font-size:0.75rem">Retry same iteration</p>
    </div>
  </div>

  <!-- 7. After DONE/FAIL -->
  <div class="step center">
    <div class="dot" style="background:#2ea043"></div>
    <div class="decision" style="border-color:#2ea043">
      <h3 style="color:#3fb950">all_stories_pass()?</h3>
      <p><strong style="color:#3fb950">Yes</strong> &rarr; log COMPLETE, <code>exit 0</code> &nbsp;&nbsp;|&nbsp;&nbsp; <strong style="color:#e3b341">No</strong> &rarr; advance <code>i++</code>, next iteration</p>
    </div>
  </div>

  <div class="loop-back">
    <div class="arrow">&uarr; loop back to iteration start</div>
  </div>

</div>

<!-- Legend -->
<div class="legend">
  <h3>Signal Reference</h3>
  <div class="legend-grid">
    <div class="legend-item">
      <div class="legend-dot" style="background:#3fb950"></div>
      <span><strong>ITERATION_DONE</strong> - story passed, committed. Logged after committer (or after archive if all done).</span>
    </div>
    <div class="legend-item">
      <div class="legend-dot" style="background:#e3b341"></div>
      <span><strong>ITERATION_FAIL</strong> - quality gate failed. Story notes updated, no retry.</span>
    </div>
    <div class="legend-item">
      <div class="legend-dot" style="background:#f85149"></div>
      <span><strong>ITERATION_BLOCKED</strong> - environment/tooling broken. Loop stops, needs human fix.</span>
    </div>
    <div class="legend-item">
      <div class="legend-dot" style="background:#8b949e"></div>
      <span><strong>TIMEOUT</strong> - no signal in 45 minutes. Watcher forces /exit, retries same iteration.</span>
    </div>
    <div class="legend-item" style="grid-column: span 2; margin-top:8px; padding-top:12px; border-top: 1px solid #30363d;">
      <span style="color:#8b949e">The watcher greps for <code>[i/MAX] .*orchestrator: ITERATION_</code> scoped to the current iteration number, so signals from previous iterations are ignored.</span>
    </div>
  </div>
</div>

</body>
</html>
