# Ralph+ Progress Log
Started: Mon 16 Feb 2026 13:15:22 AEDT
Task: task-pipeline-observability.json
---

## Codebase Patterns

1. **bats test structural assertions**: Use `declare -f` to inspect function body for structural assertions. Example: `declare -f main_loop | grep -q "UP)"` verifies that a specific case branch exists in the function definition without needing to execute the function.

2. **shellcheck quality bar**: `--severity=warning` is the effective quality gate for bash code. Info and style findings are pre-existing and not blockers. Focus linting on warnings and errors only.

3. **bats section boundary detection (macOS/BSD awk)**: Use awk to extract sections bounded by markdown headings: `awk '/^## SectionName/{found=1; next} found && /^## /{exit} found{n++} END{print n+0}' file` counts lines in the section. This avoids sed limitations on macOS (no -i flag, can't use | head -n -1 reliably). The pattern: find start, skip it (next), exit on next heading, count intermediate lines.

---

## 2026-02-16 - US-001: Remove arrow key handling from dashboard

- Removed all arrow key case branches (UP, DOWN, LEFT, RIGHT) from four main loops: main_loop, multi_task_loop, story_detail_loop, and log_loop
- The read_key function continues to consume escape sequences to prevent garbage output, but returned escape code values now fall through unmatched to the caller
- Updated all help text across multiple screens to show only j/k/h/l/Enter navigation keys
- Added 10 new bats tests (tests 33-42) to verify arrow key removal and that j/k/h/l/Enter still work correctly
- Files changed: ralph-plus/dashboard.sh, tests/dashboard.bats
- **Learnings for future iterations:**
  - bats test structural assertions can use `declare -f` to inspect function body for case branch existence
  - shellcheck at --severity=warning is the effective quality bar for shell scripts (info/style findings are pre-existing)
  - Consuming escape sequences in read_key prevents garbage output even when cases are not matched

---

## 2026-02-16 - US-002: Add auto-refresh to dashboard activity log view

- Added auto-refresh capability to log_loop by replacing blocking read with `read -rsn1 -t 3` timeout, causing automatic re-render every 3 seconds
- log_loop now uses inline read with timeout and inline escape sequence handling instead of calling read_key, allowing timeout to trigger re-render
- show_log header now displays [auto] indicator in cyan and help text shows "auto 3s" for user clarity
- Changed head line count from 20 to 30 in show_log for more context in activity log display
- Manual key handling preserved: h/Esc returns to overview, q quits, r forces immediate refresh, empty string from timeout continues loop
- Added 9 new bats tests to verify auto-refresh header, help text, 30-line read, timeout behavior, and key handling
- Files changed: ralph-plus/dashboard.sh, tests/dashboard.bats
- **Learnings for future iterations:**
  - log_loop uses inline read with timeout instead of read_key to enable auto-refresh without modifying read_key function
  - bash 3.2 on macOS returns exit code 1 for read -t timeout (not 142), requiring `|| true` to prevent set -e failure
  - Escape sequence handling must be duplicated in log_loop to avoid modifying read_key function signature or side effects

---

## 2026-02-16 - US-003: Validate heartbeat logging with a proof-of-concept test

- Created test-heartbeat.sh: a self-contained PoC test script that validates the heartbeat logging mechanism
- The script creates a temp activity log with a seed line, invokes claude --print with Bash tool to prepend 3 heartbeat lines, then verifies lines exist in correct order with seed preserved
- Outputs PASS/FAIL with details; uses --model haiku for cost/speed
- Files changed: ralph-plus/test-heartbeat.sh (NEW)
- **Learnings for future iterations:**
  - claude --print with --allowedTools Bash --dangerously-skip-permissions can be used for automated testing of agent behaviors
  - seed line technique validates prepend ordering (last line should be the original seed when prepending newer lines to the top)

---

## 2026-02-16 - US-004: Add heartbeat logging instructions to all agent definitions

- Added Heartbeat Logging section to all five pipeline agent definitions (planner, tdd, e2e, quality-gate, committer)
- Each section instructs the agent to prepend progress lines to the activity log at meaningful milestones using the documented mktemp prepend pattern
- Sections reference ACTIVITY_LOG_PATH, ITERATION, and STORY_ID context variables passed by the orchestrator
- Provided agent-specific example messages: planner (analyzing codebase, looking up docs); tdd (writing tests, N/M tests passing); e2e (setting up browser, testing criteria); quality-gate (running typecheck, lint, tests); committer (staging files, committing, updating progress log)
- All sections are 13 lines each, well within the 15-20 line limit
- Created 26 new bats tests in tests/heartbeat-instructions.bats validating: presence of Heartbeat Logging heading, mktemp prepend pattern, context variable references, agent-specific examples, and section length constraints
- Files changed: agents/planner.md, agents/tdd.md, agents/e2e.md, agents/quality-gate.md, agents/committer.md, tests/heartbeat-instructions.bats (NEW)
- **Learnings for future iterations:**
  - Use awk for section extraction in bats tests for macOS (BSD) compatibility over sed | head -n -1
  - Agent definition markdown files follow a consistent template structure for new sections
  - Each agent's heartbeat examples should reflect the specific work type and terminology

---

## 2026-02-16 - US-005: Update orchestrator to pass heartbeat context to agents

- Added "Context to pass to every agent" subsection to the Pipeline section of ralph-plus/CLAUDE.md (lines 24-30)
- The subsection instructs the orchestrator to include three values at the top of every agent Task prompt: Activity log path (from .current-activity-log), Iteration (from .current-iteration), and Story ID
- This context is added once in the general subsection, not repeated per agent definition
- Existing agent prompt instructions (Planner, TDD, E2E, Quality Gate, Committer) remain unchanged
- Created 13 new bats tests in tests/orchestrator-context.bats validating: heading presence/placement, references to .current-activity-log and .current-iteration, story ID reference, explicit format phrase, subsection ordering, uniqueness, and that all five agent subsections still exist and are not internally modified
- Files changed: ralph-plus/CLAUDE.md, tests/orchestrator-context.bats (NEW)
- **Learnings for future iterations:**
  - Markdown subsection additions tested via awk section extraction: awk '/^### Context/{found=1} found && /^###? / && !/^### Context/{exit} found{print}' extracts subsection content between first matching heading and next heading
  - Integration tests verify existing content unchanged by checking verbatim lines from agent subsections using grep (e.g. grep -q 'Spawn `planner`. Pass: story details...')
  - awk pattern for extracting subsection between two heading levels: use next to skip the start heading, exit on next heading at same or higher level, print intermediate lines

---
